# Batch Generation Guide

This guide provides detailed instructions for the batch generation workflow to efficiently generate specifications for multiple contracts.

## Overview

The batch generation workflow uses a two-stage approach:

1. **Stage 1: Skeleton Generation** - Use a script to automatically generate the basic structure for all contracts
2. **Stage 2: AI Enhancement** - Use the contract-spec-generator skill to add detailed descriptions and error tracking

This approach provides the following benefits:
- âœ… Consistent structure across all contracts
- âœ… Faster initial setup (parallel skeleton generation)
- âœ… AI focuses on high-value tasks (descriptions, error tracking, modifier information)
- âœ… Easy to regenerate or update multiple contracts

---

## Prerequisites

Before running this workflow, you need the following:

### 1. Foundry (forge) Installation and Configuration

```bash
# Install Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# Verify
forge --version
```

### 2. Project Structure

```
contract/
â”œâ”€â”€ src/                          # Solidity source files
â”‚   â”œâ”€â”€ StablecoinCore.sol
â”‚   â”œâ”€â”€ StablecoinBank.sol
â”‚   â””â”€â”€ ... (other contracts)
â”œâ”€â”€ out/                          # Build artifacts (generated by forge build)
â”‚   â”œâ”€â”€ StablecoinCore.sol/
â”‚   â”‚   â””â”€â”€ StablecoinCore.json
â”‚   â””â”€â”€ ...
â”œâ”€â”€ generate-openapi-specs.js     # Skeleton generation script
â””â”€â”€ ...

docs/
â””â”€â”€ contract/                      # Output location for generated specifications
    â”œâ”€â”€ StablecoinCore/
    â”‚   â”œâ”€â”€ StablecoinCore.openapi.yaml
    â”‚   â””â”€â”€ StablecoinCore.swagger.json
    â””â”€â”€ ...
```

### 3. Build Contracts

Before running the script, build contracts with forge to generate ABIs:

```bash
cd contract
forge build
```

---

## Stage 1: Skeleton Generation

### Step 1: Verify Script

Confirm that the `contract/generate-openapi-specs.js` script exists. This script generates **high-quality skeletons**:

**Auto-generated content:**
- âœ… **Function paths** (with auto-generated descriptions)
  - Role constant (`_ROLE`) descriptions
  - ERC20 standard function descriptions
  - Pausable function descriptions
  - AccessControl function descriptions
  - Bank operation descriptions
  - Proposal function (propose*, approve*, execute*) descriptions
  - Getter function (get*, is*, has*, can*) auto-inferred descriptions
- âœ… **Accurate type mappings** (pattern validation + examples)
  - `address` â†’ pattern: `^0x[0-9a-fA-F]{40}$`, example: `0x1234...7890`
  - `bytes4` â†’ pattern: `^0x[0-9a-fA-F]{8}$`, example: `0x12345678`
  - `bytes32` â†’ pattern: `^0x[0-9a-fA-F]{64}$`, example: `0x1234...1234`
  - `uint256` â†’ example: `1000000000000000000`
  - `bool` â†’ example: `true`
- âœ… **Common errors auto-added to write functions**
  - `InvalidAddress` (when address parameter exists)
  - `AmountZero` (when amount/value parameter exists)
  - `AccessControlUnauthorizedAccount` (role-related functions)
  - `BankNotFound`, `BankInactive` (Bank-related functions)
- âœ… **Event paths** (with complete information)
- âœ… **Error paths** (with complete information)
- âœ… **Basic schemas** (ErrorResponse, Event schemas)
- âš ï¸ **TODO markers** (only for internal function error tracking - processed in Stage 2)

### Step 2: Execute Script

```bash
cd contract
node generate-openapi-specs.js
```

### Expected Output

```
ðŸš€ Starting OpenAPI specification generation...

Processing contracts:
âœ“ AccessControlMultiSig.sol
âœ“ MultiSigWallet.sol
âœ“ DualKeyMultiSig.sol
âœ“ MultiAdminAccessControl.sol
âœ“ RoleMultiSigManager.sol
âœ“ BankPausable.sol
âœ“ BankScopedRoles.sol
âœ“ StablecoinAdmin.sol
âœ“ StablecoinBank.sol
âœ“ StablecoinCore.sol
âœ“ StablecoinIssuance.sol
âœ“ StablecoinRoles.sol
âœ“ StablecoinStorage.sol
âœ“ StablecoinTransfer.sol
âœ“ StablecoinView.sol
âœ“ ERC20SoladyUpgradeable.sol
âœ“ BalanceHandler.sol
âœ“ Dictionary.sol

âœ… Generated 18 OpenAPI and Swagger specifications

ðŸ“Œ Next Steps:
Use contract-spec-generator skill to add:
  - Internal function error tracking (add errors from internal function calls to existing 500 responses)
  - Modifier information (add modifier effects to function descriptions)
  - Contract-specific logic descriptions (replace any remaining generic descriptions)
```

### Generated File Structure

```
docs/contract/
â”œâ”€â”€ StablecoinCore/
â”‚   â”œâ”€â”€ StablecoinCore.openapi.yaml    # OpenAPI 3.0 YAML (skeleton)
â”‚   â””â”€â”€ StablecoinCore.swagger.json    # Swagger 2.0 JSON (skeleton)
â”œâ”€â”€ StablecoinBank/
â”‚   â”œâ”€â”€ StablecoinBank.openapi.yaml
â”‚   â””â”€â”€ StablecoinBank.swagger.json
â””â”€â”€ ... (all 18 contracts)
```

### Skeleton File Contents

Generated **high-quality skeleton** files include the following:

**Header (YAML file):**
```yaml
# file: docs/contract/StablecoinCore/StablecoinCore.openapi.yaml
# Generated by: contract-spec-generator skill (enhanced from skeleton)

openapi: 3.0.3
info:
  title: "StablecoinCore Solidity Interface"
  version: "1.0.0"
  description: |
    A specification expressing the StablecoinCore contract's Solidity interface in OpenAPI format.

    This contract inherits from the following contracts:

    StablecoinHelpers, IStablecoinCore.
```

**Function path example (ERC20 standard function - auto-described):**
```yaml
  /balanceOf:
    get:
      summary: "balanceOf"
      description: |
        Retrieves the token balance of the specified account.

        This is an ERC20 standard function.
      operationId: balanceOf
      parameters:
        - name: account
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "account (Solidity: address)."
          example: "0x1234567890123456789012345678901234567890"
      responses:
        "200":
          description: "Response on successful completion."
          content:
            application/json:
              schema:
                type: object
                properties:
                  result0:
                    type: string
                    description: "result0 (Solidity: uint256)."
                    example: "1000000000000000000"
```

**Function path example (Role constant - auto-described):**
```yaml
  /ALLOWLIST_ROLE:
    get:
      summary: "ALLOWLIST_ROLE"
      description: |
        Retrieves the identifier for the ALLOWLIST_ROLE role.

        This role manages permissions for allowlist-related operations.
      operationId: ALLOWLIST_ROLE
      responses:
        "200":
          description: "Response on successful completion."
          content:
            application/json:
              schema:
                type: object
                properties:
                  result0:
                    type: string
                    pattern: "^0x[0-9a-fA-F]{64}$"
                    description: "result0 (Solidity: bytes32)."
                    example: "0x1234567890123456789012345678901234567890123456789012345678901234"
```

**Function path example (Write function - common errors added, TODO: internal function error tracking):**
```yaml
  /initialize:
    post:
      summary: "initialize"
      description: |
        initialize

        TODO: Add detailed description using contract-spec-generator skill.
      operationId: initialize
      parameters:
        - name: name_
          in: query
          required: true
          schema:
            type: string
          description: "name_ (Solidity: string)."
          example: "Example String"
        - name: symbol_
          in: query
          required: true
          schema:
            type: string
          description: "symbol_ (Solidity: string)."
          example: "Example String"
        - name: trustBankPrimary
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "trustBankPrimary (Solidity: address)."
          example: "0x1234567890123456789012345678901234567890"
        - name: trustBankBackup
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "trustBankBackup (Solidity: address)."
          example: "0x1234567890123456789012345678901234567890"
        - name: developerPrimary
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "developerPrimary (Solidity: address)."
          example: "0x1234567890123456789012345678901234567890"
        - name: developerBackup
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "developerBackup (Solidity: address)."
          example: "0x1234567890123456789012345678901234567890"
      responses:
        "200":
          description: "Response on successful completion."
          content:
            application/json:
              schema:
                type: object
        "500":
          description: "List of errors that can occur in this function.\n\nãƒ»InvalidAddress\n\nTODO: Track and add internal function errors using contract-spec-generator skill."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
```

**Stage 1 Deliverables:**
- âœ… 70-80% of function descriptions auto-generated (ERC20, Pausable, AccessControl, Proposal, Getter, etc.)
- âœ… Pattern validation + examples set for all types
- âœ… Common errors added to write functions
- âš ï¸ Only TODO markers for internal function error tracking remain (processed in Stage 2)

---

## Stage 2: AI Enhancement

### Overview

**Stage 2 Focus:** Since Stage 1 script already handles 70-80%, Stage 2 focuses on:

1. **Internal function error tracking** - Add internal function errors to existing 500 responses
2. **500 error examples (Required)** - Create examples section for all errors
3. **Parameter descriptions (Required)** - Add meaningful descriptions beyond type information (e.g., `spender` â†’ "Specifies the address to approve for token spending")
4. **Modifier information** - Add modifier effects to function descriptions
5. **Contract-specific descriptions** - Replace remaining TODOs with detailed descriptions

**Required:** 500 responses must have an `examples` section. Define a named example with `summary` and `value` for each error. If there are 9 errors, define 9 named examples.

**Important:** Do not change content already processed in Stage 1 (ERC20 descriptions, type mappings, common errors).

---

### Step 1: Call contract-spec-generator Skill

For each contract, call the skill as follows:

```
Use contract-spec-generator skill to enhance StablecoinCore specifications
```

### Step 2: Skill Operations

The skill automatically performs the following steps:

1. **Load high-quality skeleton file**
   - Load `docs/contract/StablecoinCore/StablecoinCore.openapi.yaml`
   - Identify TODO markers (only internal function error tracking)
   - Preserve already auto-generated descriptions

2. **Detailed source code analysis**
   - Load `contract/src/StablecoinCore.sol`
   - Trace inheritance chain (`StablecoinHelpers.sol`, `IStablecoinCore.sol`, etc.)
   - **Track internal function calls** (e.g., `initialize()` â†’ `__Stablecoin_init()` â†’ `_grantRole()`)
   - **Identify internal function errors** (e.g., `AccessControlBadConfirmation` thrown by `_grantRole()`)
   - Understand modifier effects (e.g., `whenNotPaused`, `onlyRole`)

3. **Load specification generation rules**
   - Load detailed rules from `references/spec-prompt.md`
   - Verify formatting rules

4. **Replace TODO markers and extend**
   - **Track internal function errors** and add to existing 500 responses
     - Example: Add `InvalidInitialization`, `AccessControlBadConfirmation` to `initialize()` 500 response
   - **Add modifier information to function descriptions**
     - Example: "This function has the `whenNotPaused` modifier applied"
   - **Replace remaining TODOs with detailed descriptions**
     - Explain contract-specific logic

5. **Update both files**
   - Update OpenAPI YAML file
   - Update Swagger JSON file
   - **Preserve existing auto-generated content (ERC20 descriptions, type patterns, etc.)**

### Step 3: Enhanced Content Example

**Function description (after enhancement - internal function error tracking + modifier info added):**
```yaml
  /initialize:
    post:
      summary: "initialize"
      description: |
        Initializes the stablecoin contract. Sets token metadata and dual-key addresses.

        This function can only be called once during initialization (modifier: initializer).

        **Operations performed:**
        1. Address validation (verify all addresses are non-zero)
        2. Initialize inherited contracts (ERC20, Pausable, AccessControlMultiSig, BankPausable, BankScopedRoles)
        3. Grant roles:
           - Grant TRUST_BANK_ROLE to trustBankPrimary and trustBankBackup
           - Grant DEVELOPER_ROLE to developerPrimary and developerBackup
           - Grant operational roles (PAUSER_ROLE, ISSUER_ROLE, UPGRADER_ROLE, etc.) to trustBankPrimary
        4. Set multisig requirements (require multisig for TRUST_BANK_ROLE and DEVELOPER_ROLE)
        5. Initialize dual-key structure
        6. Add all keyholders to allowlist

        **Notes:**
        - Can only be called via proxy
        - All address parameters must not be zero address
      operationId: initialize
      parameters:
        - name: name_
          in: query
          required: true
          schema:
            type: string
          description: "Token name (e.g., JPY Stablecoin)"
          example: "JPY Stablecoin"
        - name: symbol_
          in: query
          required: true
          schema:
            type: string
          description: "Token symbol (e.g., JPYS)"
          example: "JPYS"
        - name: trustBankPrimary
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "Primary key address for TRUST_BANK_ROLE"
          example: "0x1234567890123456789012345678901234567890"
        - name: trustBankBackup
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "Backup key address for TRUST_BANK_ROLE"
          example: "0x2234567890123456789012345678901234567890"
        - name: developerPrimary
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "Primary key address for DEVELOPER_ROLE"
          example: "0x3234567890123456789012345678901234567890"
        - name: developerBackup
          in: query
          required: true
          schema:
            type: string
            pattern: "^0x[0-9a-fA-F]{40}$"
          description: "Backup key address for DEVELOPER_ROLE"
          example: "0x4234567890123456789012345678901234567890"
      responses:
        "200":
          description: "Initialization successful"
          content:
            application/json:
              schema:
                type: object
        "500":
          description: |
            List of errors that can occur in this function.

            **Common errors:**
            ãƒ»InvalidAddress - When zero address is specified

            **Errors tracked from internal functions:**
            ãƒ»InvalidInitialization - When already initialized (from `initializer` modifier)
            ãƒ»AccessControlBadConfirmation - Role grant confirmation failure (from `_grantRole()`)
            ãƒ»DualKeyAlreadyInitialized - Dual-key structure already initialized (from `_initializeDualKey()`)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                InvalidAddress:
                  summary: "Zero address specified"
                  value:
                    message: "InvalidAddress"
                    data:
                      address: "0x0000000000000000000000000000000000000000"
                InvalidInitialization:
                  summary: "Already initialized"
                  value:
                    message: "InvalidInitialization"
                    data: {}
                AccessControlBadConfirmation:
                  summary: "Role grant confirmation failure"
                  value:
                    message: "AccessControlBadConfirmation"
                    data: {}
                DualKeyAlreadyInitialized:
                  summary: "Dual-key structure already initialized"
                  value:
                    message: "DualKeyAlreadyInitialized"
                    data:
                      role: "0x..."
```

**Stage 2 Changes:**
- âœ… Added detailed descriptions (contract-specific logic)
- âœ… Added modifier information ("This function can only be called once during initialization (modifier: initializer)")
- âœ… Tracked internal function errors (`InvalidInitialization`, `AccessControlBadConfirmation`, `DualKeyAlreadyInitialized`)
- âœ… Detailed error examples (trigger conditions and data structures for each error)
- âœ… Preserved existing auto-generated content (type patterns, common errors)

### Step 4: Verification

After enhancing each contract, verify the following:

#### âœ… Stage 2 Completion Checklist

**Internal function error tracking:**
- [ ] Internal function errors added to 500 responses for all write functions
- [ ] Errors tracked across the entire inheritance chain
- [ ] Source internal function name specified for each error (e.g., "from `_grantRole()`")
- [ ] Error examples include detailed descriptions and data structures

**Parameter descriptions:**
- [ ] All parameters have meaningful descriptions (not just type information)
- [ ] Example: `spender` â†’ "Specifies the address to approve for token spending (Solidity: address)."
- [ ] Example: `amount` â†’ "Specifies the token amount to transfer (Solidity: uint256)."

**Modifier information:**
- [ ] Modifier information added to write function descriptions (e.g., "modifier: initializer")
- [ ] Modifier effects explained

**Contract-specific descriptions:**
- [ ] All remaining TODO markers resolved
- [ ] Contract-specific logic explained in detail
- [ ] Operations performed clearly listed

**Preservation of existing content:**
- [ ] ERC20 descriptions auto-generated in Stage 1 preserved
- [ ] Type patterns (pattern, example) added in Stage 1 preserved
- [ ] Common errors added in Stage 1 preserved

**Formatting rules:**
- [ ] No backticks around function names, event names, error names
- [ ] No suffixes like "function", "event", "error"
- [ ] All descriptions in appropriate language
- [ ] HTTP 200 for success, HTTP 500 for all errors
- [ ] Variable names and Solidity identifiers (`msg.sender`, `address(0)`, etc.) have backticks

#### Verification Commands

YAML syntax check:
```bash
# Using yamllint (optional)
yamllint docs/contract/StablecoinCore/StablecoinCore.openapi.yaml
```

JSON syntax check:
```bash
# Using jq
jq . docs/contract/StablecoinCore/StablecoinCore.swagger.json > /dev/null && echo "Valid JSON"
```

### Step 5: Enhance All Contracts

Repeat Steps 1-4 for the remaining 17 contracts.

**Efficient execution:**
```
Use contract-spec-generator skill to enhance StablecoinBank specifications
Use contract-spec-generator skill to enhance StablecoinIssuance specifications
Use contract-spec-generator skill to enhance StablecoinTransfer specifications
...
```

---

## Troubleshooting

### Problem 1: Script Cannot Find ABI

**Symptom:**
```
Error: Cannot find ABI for ContractName
```

**Solution:**
```bash
# Run forge build to generate ABIs
cd contract
forge build

# Verify ABI was generated in out/ directory
ls -la out/StablecoinCore.sol/StablecoinCore.json
```

### Problem 2: Internal Function Errors Not Tracked

**Symptom:** 500 responses don't include internal function errors

**Solution:**
1. Check the "Error Tracking" section in `references/spec-prompt.md`
2. Manually check internal functions in source code and list errors
3. Explicitly instruct the skill to add internal function errors

```
For StablecoinCore.mint(), also track errors from internal functions:
- _mint(): "ERC20: mint amount exceeds cap"
- _beforeTokenTransfer(): "Pausable: token transfer while paused"
```

### Problem 3: YAML/JSON Syntax Error

**Symptom:** Generated files are invalid YAML/JSON

**Solution:**
1. Check error message
2. Verify indentation (YAML uses 2 spaces)
3. Escape special characters
4. Use `|` or `>` for multi-line strings

### Problem 4: Formatting Rule Violation

**Symptom:** Backticks or suffixes present

**Solution:**
1. Re-check "Key Formatting Rules" in `references/spec-prompt.md`
2. Explicitly re-communicate formatting rules to the skill

```
Please ensure:
- No backticks around function/event/error names
- No suffixes like "function", "event", "error"
```

---

## Best Practices

### 1. Prioritize Contracts

Enhance contracts in order of importance:

1. **Core contracts**: StablecoinCore, StablecoinBank
2. **Feature contracts**: StablecoinIssuance, StablecoinTransfer
3. **Admin contracts**: StablecoinAdmin, StablecoinRoles
4. **Support contracts**: Others

### 2. Commit in Batches

Commit with git after enhancing each contract:

```bash
git add docs/contract/StablecoinCore/
git commit -m "docs: enhance StablecoinCore specifications with detailed descriptions"
```

### 3. Review Cycles

Review generated specifications every 3-5 contracts:
- Consistency of formatting rules
- Accuracy of internal function error tracking
- Quality of descriptions

### 4. Verify with Documentation Site

After completing all contract enhancements, visually verify with the Docusaurus site:

```bash
cd docs-site
npm run start
```

Verify the following at `http://localhost:3000`:
- All contracts are displayed
- Functions, events, and errors show in sidebar
- Descriptions display correctly
- Response examples display appropriately

---

## Completion Criteria

Criteria for determining batch generation workflow completion:

### Stage 1 Completion Criteria (Script Execution)
- [ ] High-quality skeleton files generated for all 18 contracts
- [ ] Both YAML and JSON exist for each contract
- [ ] 70-80% of function descriptions auto-generated (ERC20, Pausable, AccessControl, Proposal, Getter, etc.)
- [ ] Pattern validation + examples set for all types
- [ ] Common errors added to write functions
- [ ] TODO markers limited to internal function error tracking only

### Stage 2 Completion Criteria (AI Enhancement)
- [ ] All 18 contracts enhanced
- [ ] All TODO markers resolved
- [ ] **Internal function errors completely tracked** (across entire inheritance chain)
- [ ] **Parameter descriptions are meaningful** (not just type information)
- [ ] **Modifier information added to function descriptions**
- [ ] **Contract-specific logic explained in detail**
- [ ] Stage 1 auto-generated content preserved (ERC20 descriptions, type patterns, common errors)
- [ ] Compliant with formatting rules
- [ ] All descriptions in appropriate language
- [ ] All contracts display correctly in Docusaurus site

### Client Delivery Quality Criteria
- [ ] Complete error tracking (including internal functions) for all write functions
- [ ] Detailed examples and descriptions for all errors
- [ ] **Meaningful descriptions for all parameters** (explaining purpose, not just type)
- [ ] Modifier information for all functions (where applicable)
- [ ] Detailed explanation of contract-specific logic
- [ ] Complete compliance with formatting rules
- [ ] No YAML/JSON syntax errors
- [ ] Visually perfect display in Docusaurus

---

## Reference Links

- [SKILL.md](../SKILL.md) - Skill overview
- [spec-prompt.md](./spec-prompt.md) - Detailed specification generation rules
- [docusaurus-setup.md](./docusaurus-setup.md) - Docusaurus site setup guide
- [OpenAPI 3.0 Specification](https://swagger.io/specification/)
- [Swagger 2.0 Specification](https://swagger.io/specification/v2/)
- [Foundry Documentation](https://book.getfoundry.sh/)
